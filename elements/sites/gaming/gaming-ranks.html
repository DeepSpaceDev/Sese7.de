<dom-module id="gaming-ranks">
	<template>
		<style>
			:host {
				display: block;
			}
			iron-icon{
				height: 18px;
				width: 18px;
			}
			.n{
				fill: var(--paper-grey-500);
			}
			.w{
				fill: var(--paper-green-500);
			}
			.l{
				fill: var(--paper-red-500);
			}
		</style>

		<paper-material class="content">
			<h2>League of Legends ranking:</h2>

			<!--http://david-mulder.github.io/paper-datatable/components/paper-datatable/docs/docs.html?getting-started-->
			<paper-datatable id="lol_data" data="{{loldata}}">
				<paper-datatable-column id="lol_data_place" header="Place" property="place" sortable>
    			</paper-datatable-column>
				<paper-datatable-column id="lol_data_username" header="Username" property="username" sortable>
    			</paper-datatable-column>
    			<paper-datatable-column header="Tier Division (LP) (Series)" property="rank">
    			</paper-datatable-column>
    			<paper-datatable-column header="Total Wins/Loses" property="winlose">
    			</paper-datatable-column>
			</paper-datatable>

			<br />
			<h2>osu! ranking:</h2>

			<paper-datatable id="osu_data" data="{{osudata}}">
				<paper-datatable-column id="osu_data_place" header="Place" property="place" sortable>
    			</paper-datatable-column>
				<paper-datatable-column id="osu_data_username" header="Username (#globalrank)" property="username" sortable>
    			</paper-datatable-column>
    			<paper-datatable-column header="PP" property="pp" sortable>
    			</paper-datatable-column>
    			<paper-datatable-column header="Playcount" property="playcount" sortable>
    			</paper-datatable-column>
    			<paper-datatable-column header="Accuracy" property="accuracy" sortable>
    			</paper-datatable-column>
    			<paper-datatable-column header="SS/S/A" property="ct" sortable>
    			</paper-datatable-column>
    			<paper-datatable-column header="Level" property="level" sortable>
    			</paper-datatable-column>
			</paper-datatable>

			<br />
			<br />
			You also want to be in this statistic? Register and login, go to settings and games!
			<br />
			<br />
			<span style="font-size: 12px; color: #bbb; line-height: 0.8;">Deepspace Development isn't endorsed by Riot Games and doesn't reflect the views or opinions of Riot Games or anyone officially involved in producing or managing League of Legends. League of Legends and Riot Games are trademarks or registered trademarks of Riot Games, Inc. League of Legends Â© Riot Games, Inc.</span>
		</paper-material>
		
	</template>
	<script>
		Polymer({
			is: 'gaming-ranks',

			properties:{
				loldata: {
					type: Array,
					value: []
				},

				osudata: {
					type: Array,
					value: []
				}
			},

			attached: function(){
				this.loldata = [];
				this.$.lol_data.progress = true;
				this.osudata = [];
				this.$.osu_data.progress = true;

				asyncAjax("../../../scripts/sites/gaming.php", "", this._handleResponse.bind(this));
			},

			_handleResponse: function(e){
				var response = JSON.parse(e.responseText);
				this.$.lol_data.reset();
				this.$.osu_data.reset();

				this._processLolData(response);
				this._processOsuData(response);
				
				this.$.lol_data.progress = false;
				this.$.osu_data.progress = false;
			},

			_processOsuData: function(response){
				var users = [];

				for(var i = 0; i < response['osu']['users'].length; i++){
					users.push(response['osu']['users'][i][0]);
				}

				users.sort(function(a, b) {
			        var x = parseFloat(a['pp_raw']); 
			        var y = parseFloat(b['pp_raw']);
			       	return ((x > y) ? 0 : 1);
			    });

				for(var i = 0; i < users.length; i++){
					var user = users[i];
					var data = {place: i + 1, username: user['username'] + " (#" + user['pp_rank'] + ")", pp: parseFloat(user['pp_raw']).toFixed(2), playcount: user['playcount'], accuracy: parseFloat(user['accuracy']).toFixed(2), ct: user['count_rank_ss'] + "/" + user['count_rank_s'] + "/" + user['count_rank_a'], level: parseInt(user['level'])};
					this.push('osudata', data);
				}

			},

			_processLolData: function(response){
				var userdata = new Object();
				var userids = [];
				//****************************** users ******************************
				var userarray = $.map(response['lol']['users'], function(value, index) {
				    	return [value];
				}); //Skip the unknown single attr. var[0][unknown]['name']

				for(var i = 0; i < userarray.length; i++){
					var key = userarray[i]['id'];
					userdata[key] = new Object();
					userdata[key]['name'] = userarray[i]['name'];
					userids.push(key);
				}

				//****************************** users ******************************

				var ranksarray = $.map(response['lol']['ranks'], function(value, index) {
				    	return [value];
				}); //Skip the unknown single attr. var[0][unknown]['name']

				for(var i = 0; i < userids.length; i++){
					var user = userdata[userids[i]];
					var lp = 0;
					var division = "";
					var tier = "";
					var winlose = "";

					if(response['lol']['ranks'][userids[i]] !== undefined){
						tier = ucfirst(response['lol']['ranks'][userids[i]][0]['tier'].toLowerCase());
						division = response['lol']['ranks'][userids[i]][0]['entries'][0]['division'];
						lp = response['lol']['ranks'][userids[i]][0]['entries'][0]['leaguePoints'];
						userdata[userids[i]]['rank'] = tier + " " + division + " (" + lp + "LP)";

						if(lp == 100){
							var series = response['lol']['ranks'][userids[i]][0]['entries'][0]['miniSeries']['progress'];
							series = series.split("");
							var seriesicon = "";
							for(var x = 0; x < series.length; x++){
								switch(series[x]){
									case "N": seriesicon += "<iron-icon class='x-scope gaming-ranks n' icon='icons:remove'></iron-icon>"; break;
									case "W": seriesicon += "<iron-icon class='x-scope gaming-ranks w' icon='icons:check'></iron-icon>"; break;
									case "L": seriesicon += "<iron-icon class='x-scope gaming-ranks l' icon='icons:clear'></iron-icon>"; break;
								}
							}
							userdata[userids[i]]['rank'] += " " + seriesicon;
						}

						//******WinLose*****
						userdata[userids[i]]['winlose'] = response['lol']['ranks'][userids[i]][0]['entries'][0]['wins'] + "/" + response['lol']['ranks'][userids[i]][0]['entries'][0]['losses']; 

					}
					else{
						userdata[userids[i]]['rank'] = "-";
						userdata[userids[i]]['winlose'] = "-";
					}
					userdata[userids[i]]['points'] = this._calculateLolPoints(tier, division, lp);
				}


				//*******************************************************************
				
				var userdataarray = $.map(userdata, function(value, index) {
				    return [value];
				});

				userdataarray.sort(function(a, b) {
			        var x = a['points']; 
			        var y = b['points'];
			       	return ((x < y) ? 1 : 0);
			    });

				for(var i = 0; i < userdataarray.length; i++){
					var user = userdataarray[i];
					var data = {place: i + 1, username: user['name'], rank: user['rank'], winlose: user['winlose']};
					this.push('loldata', data);
				}

				qs('#lol_data').sort(this.$.lol_data_place);
			},

			_calculateLolPoints: function(t, d, l){
				var p = 0;
				switch(t){
					case "Bronze": p = p + 10000; break;
					case "Silver": p = p + 20000; break;
					case "Gold": p = p + 30000; break;
					case "Platinum": p = p + 40000; break;
					case "Diamond": p = p + 50000; break;
					case "Master": p = p + 60000; break;
					case "Challenger": p = p + 70000; break;
				}
				switch(d){
					case "I": p = p + 5000; break;
					case "II": p = p + 4000; break;
					case "III": p = p + 3000; break;
					case "IV": p = p + 2000; break;
					case "V": p = p + 1000; break;
				}
				p = p + l;
				return p;
			}
		});
	</script>
</dom-module>